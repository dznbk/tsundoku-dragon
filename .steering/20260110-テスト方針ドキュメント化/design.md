# 設計書

## 意思決定

### 採用した設計

既存の `docs/development-guidelines.md` に mock 使用方針を追加し、統合テスト専用の新規ドキュメント `docs/integration-testing.md` を作成する。

### 代替案との比較

| 案                                                    | メリット                                                               | デメリット                                        | 採用 |
| ----------------------------------------------------- | ---------------------------------------------------------------------- | ------------------------------------------------- | ---- |
| 案A: 既存ファイル拡張 + 新規ファイル                  | 関連性の高い情報が分散しない、統合テストは独立したトピックとして扱える | ファイルが分かれる                                | ✓    |
| 案B: 全て新規ファイル `docs/testing-policy.md` に集約 | 一箇所で全テスト方針が見られる                                         | 既存の `development-guidelines.md` との重複が発生 | -    |
| 案C: 全て既存ファイルに追加                           | ファイル数が増えない                                                   | ファイルが肥大化、統合テストの詳細が埋もれる      | -    |

### 選定理由

1. mockの使用方針は開発全般に関わるため、既存の `development-guidelines.md` の「テスト方針」セクションを拡張するのが自然
2. 統合テストの詳細（セットアップ、デバッグ、制限事項）は独自のトピックとして十分な分量があるため、専用ドキュメントとする
3. CLAUDE.mdのドキュメント一覧との整合性を保つ

## ドキュメント構成

### 追加・変更するファイル

| ファイル                         | 種別 | 責務                                 |
| -------------------------------- | ---- | ------------------------------------ |
| `docs/development-guidelines.md` | 変更 | mockの使用方針セクションを追加       |
| `docs/integration-testing.md`    | 新規 | 統合テストの詳細ガイド               |
| `CLAUDE.md`                      | 変更 | ドキュメント一覧に新規ファイルを追加 |

## コンテンツ設計

### development-guidelines.md への追加内容

「テスト方針」セクションの後に以下を追加:

```markdown
### mockの使用方針（デトロイト派）

#### 基本原則

**本物を使えるなら本物を使う**

#### レイヤー別mock使い分け

| レイヤー     | Unit Tests | Integration Tests   | E2E Tests    |
| ------------ | ---------- | ------------------- | ------------ |
| Repository   | Mock       | **Real (Local DB)** | Real         |
| Service      | Real       | Real                | Real         |
| External API | Mock       | Mock                | Real or Mock |

#### 判断基準

- **制御可能**: DynamoDB Local → 本物を使う
- **制御不可能**: Firebase Auth, 外部API → mockする
- **高コスト**: メール送信、課金処理 → mockする
```

### integration-testing.md の構成

1. **統合テストの目的と重要性**
   - なぜ統合テストが必要か
   - Unit/Integration/E2Eの使い分け

2. **ローカル環境のセットアップ**
   - DynamoDB Local の起動方法
   - 環境変数の設定

3. **テストの実行方法**
   - コマンド例
   - テストファイルの命名規則

4. **デバッグ方法**
   - ログ出力
   - テストデータの確認
   - よくあるエラーと対処法

5. **テストデータ管理**
   - フィクスチャの作成
   - テスト間の独立性確保

6. **DynamoDB Local の制限事項**
   - 非対応機能リスト
   - 回避策

## 影響範囲

- ドキュメントのみの変更のため、コード変更はなし
- CLAUDE.md のドキュメント一覧への反映が必要
