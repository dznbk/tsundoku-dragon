# タスクリスト

## タスク完了の原則

**このファイルの全タスクが完了するまで作業を継続すること**

### 必須ルール

- 全てのタスクを `[x]` にすること
- 未完了タスク `[ ]` を残したまま作業を終了しない
- 「時間の都合」「難しい」などの理由でのスキップは禁止

### スキップが許可されるケース

技術的理由に該当する場合のみ:

- 実装方針の変更により機能自体が不要になった
- アーキテクチャ変更により別の実装方法に置き換わった

スキップ時は理由を明記:

```markdown
- [~] タスク名 (スキップ理由: 具体的な技術的理由)
```

---

## 進捗

- 開始: 2026-01-26
- 完了: 2026-01-26

---

## フェーズ1: スキーマ・型定義

- [x] `apps/api/src/types/api.ts` に createBattleLogSchema を追加
- [x] CreateBattleLogInput 型をエクスポート

## フェーズ2: サービス層実装

- [x] BookService に recordBattle メソッドを追加
- [x] pagesRead の自動補正ロジックを実装
- [x] 討伐判定ロジックを実装

## フェーズ3: ルート実装

- [x] `apps/api/src/routes/books.ts` に POST /:id/logs ルートを追加

## フェーズ4: ユニットテスト

- [x] BookService.recordBattle のユニットテストを追加
  - [x] 正常系: ログ記録、currentPage 更新
  - [x] 正常系: 討伐時に status が completed になる
  - [x] 正常系: pagesRead が残りページを超えた場合、自動補正される
  - [x] 異常系: 存在しない本は null を返す
  - [x] 異常系: reading 以外の status はエラー
- [x] POST /books/:id/logs のルートテストを追加
  - [x] 正常系: 201 を返す
  - [x] 正常系: 討伐時のレスポンス
  - [x] 異常系: 存在しない本は 404
  - [x] 異常系: reading 以外の status は 400
  - [x] 異常系: バリデーションエラーは 400

## フェーズ5: 品質チェック

- [x] テストが通ることを確認 (`npm run test:all`)
- [x] リントエラーがないことを確認 (`npm run lint`)
- [x] 型エラーがないことを確認 (`npm run typecheck`)
- [x] フォーマットエラーがないことを確認 (`npm run format:check`)

---

## 振り返り

### うまくいったこと

- Issue #55 の仕様に沿った実装ができた
- 既存の BookService / BookRepository パターンに一貫した設計で実装できた
- pagesRead の自動補正ロジック（残りページ数を超えた場合に補正）を適切に実装
- 討伐判定（defeat フラグ）をレスポンスに含めることで、フロントエンドでの演出が容易になった
- ユニットテストで正常系・異常系を網羅

### 改善点

- 特になし。計画通りに実装できた

### 次回への学び

- 既存パターンを踏襲することで、コードレビューや将来の保守が容易になる
- Issue に詳細な仕様が書かれていると、実装がスムーズに進む

### 申し送り事項

- Issue #56（経験値計算・スキル更新ロジック）で、recordBattle の結果を使って経験値を加算する処理を追加予定
- Issue #57（戦闘画面UI）で、この API を呼び出すフロントエンド実装を行う予定

---

## 追加対応 (2026-01-26)

### フィードバック内容

- CI の統合テストが失敗: `findByUserId` がログエントリ（`BOOK#xxx#LOG#...`）も返してしまう問題
- 統合テストの並列実行による競合: `cleanupTestData` が他のテストファイルのデータを削除してしまう

### 追加タスク

- [x] `BookRepository.findByUserId` でログエントリを除外するフィルタを追加
- [x] ユニットテストにログ除外のテストケースを追加
- [x] ~~統合テスト設定に `fileParallelism: false` を追加~~ → テストの独立性を確保して並列実行可能に
- [x] ~~`bookRepository.integration.test.ts` に `beforeEach` でのクリーンアップを追加~~ → ユニークIDでの独立性確保に変更
- [x] 統合テストの独立性を確保（各テストでユニークな userId を使用）
- [x] CI が通ることを確認

### 振り返り

#### うまくいったこと

- DynamoDB の FilterExpression で SK をフィルタリングできない制約に気づき、アプリケーション側でのフィルタリングに切り替えた
- 統合テストの独立性を確保し、並列実行でも安定してテストが通るようになった

#### 学んだこと

- DynamoDB の FilterExpression はプライマリキー属性（PK, SK）には使用できない
- DynamoDB Local と本番 DynamoDB で `attribute_exists` の挙動が異なる可能性がある
- 統合テストで共有リソースを使用する場合は、`cleanupTestData` のようなグローバルクリーンアップではなく、各テストでユニークなIDを使用して独立性を確保する

#### 申し送り事項

- 将来的にログ数が増えた場合、`findByUserId` のパフォーマンスに影響する可能性がある（全件取得後にフィルタリングしているため）
